{% extends "base.html" %}

{% block title %}Loan Prediction - Loan Prediction System{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="header text-center">
    <div class="container">
        <h1 class="display-4 fw-bold">Loan Default Risk Prediction</h1>
        <p class="lead">Enter loan details below to get an instant risk assessment.</p>
    </div>
</div>

<!-- Main Content -->
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Loan Prediction Form -->
            <div class="card mb-5">
                <div class="card-header text-center">
                    <h4 class="mb-0"><i class="fas fa-calculator me-2"></i>Default Prediction</h4>
                </div>
                <div class="card-body p-4">
                    <form id="predictionForm">
                        <div class="row g-3">
                            <!-- Row 1 -->
                            <div class="col-md-4">
                                <label class="form-label">Loan Amount ($)</label>
                                <input type="number" class="form-control" id="loanAmount" name="LoanAmount" 
                                       placeholder="e.g., 15000" required min="1000" max="1000000" step="100">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Employment Length (years)</label>
                                <input type="number" class="form-control" id="empLength" name="EmploymentLength" 
                                       placeholder="e.g., 5" required min="0" max="50" step="1">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">FICO Score</label>
                                <input type="number" class="form-control" id="fico" name="FicoScore" 
                                       placeholder="700" required min="300" max="850" step="1">
                            </div>
                            
                            <!-- Row 2 -->
                            <div class="col-md-4">
                                <label class="form-label">Interest Rate (%)</label>
                                <input type="number" class="form-control" id="interestRate" name="InterestRate" 
                                       placeholder="e.g., 7.5" required min="1" max="30" step="0.1">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Annual Income ($)</label>
                                <input type="number" class="form-control" id="annualIncome" name="AnnualIncome" 
                                       placeholder="e.g., 60000" required min="10000" max="1000000" step="1000">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Debt-to-Income Ratio (%)</label>
                                <input type="number" class="form-control" id="dti" name="DebtToIncomeRatio" 
                                       placeholder="e.g., 25" required min="0" max="100" step="0.1">
                            </div>
                            
                            <!-- Row 3 -->
                            <div class="col-md-4">
                                <label class="form-label">Loan Term (months)</label>
                                <input type="number" class="form-control" id="term" name="Term" 
                                       placeholder="e.g., 36" required min="12" max="84" step="1">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Home Ownership</label>
                                <select class="form-select" id="homeOwnership" name="HomeOwnership" required>
                                    <option value="">Select Status</option>
                                    <option value="MORTGAGE">Mortgage</option>
                                    <option value="RENT">Rent</option>
                                    <option value="OWN">Own</option>
                                    <option value="OTHER">Other</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Number of Open Accounts</label>
                                <input type="number" class="form-control" id="openAccounts" name="OpenAccounts" 
                                       placeholder="e.g., 5" required min="0" max="50" step="1">
                            </div>
                        </div>
                        
                        <!-- Submit Button -->
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-predict btn-lg">
                                <i class="fas fa-calculator me-2"></i>Predict Default Risk
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div class="loading" id="loadingIndicator" style="display:none;">
                <div class="spinner"></div>
                <p class="mt-3 text-muted">Analyzing loan data...</p>
            </div>

            <!-- Prediction Result -->
            <div class="result-box" id="predictionResult" style="display:none;">
                <!-- Results will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Handle prediction form submission
document.getElementById('predictionForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const loading = document.getElementById('loadingIndicator');
    const resultBox = document.getElementById('predictionResult');
    loading.style.display = 'block';
    resultBox.style.display = 'none';
    
    const formData = {
        LoanAmount: parseFloat(document.getElementById('loanAmount').value),
        InterestRate: parseFloat(document.getElementById('interestRate').value),
        Term: parseInt(document.getElementById('term').value),
        EmploymentLength: parseFloat(document.getElementById('empLength').value),
        AnnualIncome: parseFloat(document.getElementById('annualIncome').value),
        DebtToIncomeRatio: parseFloat(document.getElementById('dti').value),
        FicoScore: parseFloat(document.getElementById('fico').value),
        OpenAccounts: parseInt(document.getElementById('openAccounts').value),
        HomeOwnership: document.getElementById('homeOwnership').value
    };
    
    try {
        const response = await fetch('/api/predict', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(formData)
        });

        // If response is HTML, probably redirected to login
        const contentType = response.headers.get("content-type");
        if (!response.ok || !contentType || !contentType.includes("application/json")) {
            throw new Error("You are not logged in or server returned an error.");
        }
        
        const data = await response.json();

        if (data.status === 'success') {
            displayResult(data, formData);
        } else {
            throw new Error(data.error || 'Prediction failed.');
        }

    } catch (err) {
        console.error(err);
        displayError(err.message);
    } finally {
        loading.style.display = 'none';
    }
});

function displayResult(result, formData) {
    const resultBox = document.getElementById('predictionResult');
    resultBox.style.display = 'block';
    const riskPercent = (result.probability * 100).toFixed(1);
    const predictionText = result.prediction === 1 ? "High Default Risk" : "Low Default Risk";
    const riskLevel = result.risk_level ? result.risk_level.toLowerCase() : "low";

    let colorClass = riskLevel.includes("high") ? "danger" :
                     riskLevel.includes("medium") ? "warning" : "success";

    let resultHTML = `<h4 class="text-${colorClass}">${predictionText}: ${riskPercent}%</h4>
                      <p>${riskLevel.charAt(0).toUpperCase() + riskLevel.slice(1)} risk based on analysis.</p>
                      <div class="progress my-3">
                        <div class="progress-bar bg-${colorClass}" role="progressbar" style="width: ${riskPercent}%;" 
                             aria-valuenow="${riskPercent}" aria-valuemin="0" aria-valuemax="100">${riskPercent}%</div>
                      </div>`;
    
    // Feedback
    const feedback = provideRiskFeedback(formData);
    resultHTML += feedback;

    resultBox.innerHTML = resultHTML;
    resultBox.className = `result-box alert alert-${colorClass}`;
}

function displayError(message) {
    const resultBox = document.getElementById('predictionResult');
    resultBox.style.display = 'block';
    resultBox.className = 'result-box alert alert-danger';
    resultBox.innerHTML = `<h4 class="text-danger">Error</h4><p>${message}</p>`;
}

function provideRiskFeedback(formData) {
    const feedback = [];
    const loanToIncome = formData.LoanAmount / formData.AnnualIncome;

    if (loanToIncome > 4) feedback.push("Loan amount is very high relative to income");
    else if (loanToIncome > 2.5) feedback.push("Loan amount is high relative to income");

    if (formData.DebtToIncomeRatio > 43) feedback.push("Debt-to-income ratio is above recommended levels");
    else if (formData.DebtToIncomeRatio > 36) feedback.push("Debt-to-income ratio is elevated");

    if (formData.InterestRate > 12) feedback.push("Interest rate is quite high");
    if (formData.FicoScore < 650) feedback.push("Credit score is below ideal range");
    if (formData.EmploymentLength < 2) feedback.push("Employment history is relatively short");

    if (feedback.length > 0) {
        return `<div class="mt-3">
            <h5>Key Factors:</h5>
            <ul class="text-start">
                ${feedback.map(f => `<li>${f}</li>`).join('')}
            </ul>
        </div>`;
    }

    return `<div class="mt-3">
        <h5>Key Factors:</h5>
        <p>Financial profile shows good indicators for loan approval.</p>
    </div>`;
}
</script>
{% endblock %}
